#ifndef TrapList_CPP
#define TrapList_CPP

#include "TrapList.h"
#include "SNMPDefine.h"
#include "SNMPPdu.h"
#include "TimeTicks.h"
#include "Integer32.h"
#include "AlarmRecord.h"
#include "EthMemory.h"
#include <string.h>
#include "DeviceComponent.h"
#include "DeviceAttribute.h"
#ifdef EZ_DEBUG
#include <stdio.h>
#endif

extern "C" void SendFrameBySwitch(LAYER2FRAME* frame);

uint32 OIDImplTimeticks[] = { 1, 3, 6, 1, 2, 1, 1, 3, 0 };//time
uint32 OIDTrapFix[] = { 1, 3, 6, 1, 6, 3, 1, 1, 4, 1, 0 };//TRAP OID
uint32 OIDTrapEnterpriseFix[] = { 1, 3, 6, 1, 6, 3, 1, 1, 4, 3, 0 };

uint32 OIDTrapList[] = { 1, 3, 6, 1, 4, 1, 25449, 1, 1, 12, 1, 1, 0, 3000 };
uint32 OIDImplEventID[] = { 1, 3, 6, 1, 4, 1, 25449, 1, 1, 12, 2, 0 };
uint32 OIDImplTrapItem[] = { 1, 3, 6, 1, 4, 1, 25449, 1, 1, 12, 3, 0 };

TASK void tsk_trap(void);

uint16 udp_listen_ack(uint8 socket, uint8 *remip, uint16 remport, uint8 *buf, uint16 len) {
    return 0;
}

TrapList TrapList::t;

TrapList::TrapList(void) {

    memset((uint8*) &trapBuffer, 0, sizeof(TrapBuffer) * TrapMaxNumber);
    currentIndex = 0;
    endIndex = 0;
    soc_massage = 0;
    tsk_send_trap = 0;

}
TrapList::~TrapList(void) {
}
void TrapList::Initial(void) {
    soc_massage = udp_get_socket(0, UDP_OPT_SEND_CS | UDP_OPT_CHK_CS, udp_listen_ack);
    if( soc_massage == 0 ) {
        printf("\n!!!soc_massage = udp_get_socket failed!!!\n");
        return ;
    }
    if( !udp_open( soc_massage, 162 ) ) {
        return ;
    }
    tsk_send_trap = os_tsk_create(tsk_trap, P_FILE_SYNC);
}

void TrapList::deInitial(void) {
    os_tsk_delete(tsk_send_trap);
    udp_close(soc_massage);
    udp_release_socket(soc_massage);
}

/*
 * 生成告警产生报文，并加入到发送队列
 */
void TrapList::insertNewAlarmTrap(AlarmRecord *type) {

    if (type == NULL)
        return;

    /*检查trapbuf是否满*/
    if (endIndex != currentIndex) {
        //�Ƿ�buffer������� ����
        if ((endIndex == TrapMaxNumber - 1) && currentIndex == 0) {
            return;
        } else if ((endIndex + 1) == currentIndex) {
            return;
        }
    }

    /*VBS 初始化*/
    OIDImplTrapItem[10] = 3;
    OIDImplEventID[10] = 2;
    SNMPPdu pdu;
    pdu.commond = SNMPPdu::TRAP;
    VariableBinding vb[5];
    pdu.variableBindings.variableBinding = vb;
    pdu.variableBindings.vbsLength = 5;

    /*1.3.6.1.2.1.1.3.0 Timeticks*/
    OID oid1(OIDImplTimeticks, 9);
    pdu.variableBindings.getAt(0)->setOID(&oid1);
    TimeTicks value1(type->itsRaiseTime());
    pdu.variableBindings.getAt(0)->setValue(&value1);

    /*1.3.6.1.6.3.1.1.4.1.0 TrapOID*/
    OID oid2(OIDTrapFix, 11);
    pdu.variableBindings.getAt(1)->setOID(&oid2);
    OIDImplEventID[11] = type->itsAlarmType();
    OID value2(OIDImplEventID, 12);
    pdu.variableBindings.getAt(1)->setValue(&value2);

    //trap alarm �澯��Ŀ����

    OIDImplTrapItem[11] = 1;
    OID oid3(OIDImplTrapItem, 12);
    pdu.variableBindings.getAt(2)->setOID(&oid3);
    Integer32 value3(type->itsSN());
    pdu.variableBindings.getAt(2)->setValue(&value3);

    //�澯ԴID

    OIDImplTrapItem[11] = 2;
    OID oid4(OIDImplTrapItem, 12);
    pdu.variableBindings.getAt(3)->setOID(&oid4);
    Integer32 value4(type->itsAlarmSource());
    pdu.variableBindings.getAt(3)->setValue(&value4);

    //�澯����

    OIDImplTrapItem[11] = 3;
    OID oid5(OIDImplTrapItem, 12);
    pdu.variableBindings.getAt(4)->setOID(&oid5);
    Integer32 value5(type->itsAlarmLevel());
    pdu.variableBindings.getAt(4)->setValue(&value5);

    int pklen = pdu.getPDUBerLength();
    int buflen = pklen + 1 + SNMPPdu::getLengthBerLength(pklen);

    ///unsigned char *buf = new unsigned char[buflen];
    if (pdu.encode((unsigned char*) trapBuffer[endIndex].buffer, buflen,
            pklen)) {
        trapBuffer[endIndex].buffersize = buflen;
        trapBuffer[endIndex].valid = 1;
    } else {
        trapBuffer[endIndex].buffersize = 0;
        trapBuffer[endIndex].valid = 0;
    }

    pdu.variableBindings.variableBinding = NULL;
    endIndex++;
    if (endIndex >= TrapMaxNumber) {
        endIndex = 0;
    }

//sendUint32Value( Get_Time() - bt  );
}
void TrapList::insertRecoveryAlarmTrap(AlarmRecord *type, uint32 timetick) {
//sendUint32Value(0xaD000000);
//uint32 bt = Get_Time();

    if (type == NULL)
        return;
    if (endIndex != currentIndex) {
        //�Ƿ�buffer������� ����
        if ((endIndex == TrapMaxNumber - 1) && currentIndex == 0) {
            return;
        } else if ((endIndex + 1) == currentIndex) {
            return;
        }
    }
    OIDImplTrapItem[10] = 3;
    OIDImplEventID[10] = 2;
    SNMPPdu pdu;
    pdu.commond = SNMPPdu::TRAP;
    VariableBinding vb[5];
    pdu.variableBindings.variableBinding = vb;
    pdu.variableBindings.vbsLength = 5;
    //trap����ʱ��

    OID oid1(OIDImplTimeticks, 9);
    pdu.variableBindings.getAt(0)->setOID(&oid1);
    TimeTicks value1(timetick * 100);
    pdu.variableBindings.getAt(0)->setValue(&value1);

    //trap�¼�ID

    OID oid2(OIDTrapFix, 11);
    pdu.variableBindings.getAt(1)->setOID(&oid2);
    OIDImplEventID[11] = type->itsAlarmType() | 0x8000;
    OID value2(OIDImplEventID, 12);
    pdu.variableBindings.getAt(1)->setValue(&value2);

    //trap alarm �澯��Ŀ����

    OIDImplTrapItem[11] = 1;
    OID oid3(OIDImplTrapItem, 12);
    pdu.variableBindings.getAt(2)->setOID(&oid3);
    Integer32 value3(type->itsSN());
    pdu.variableBindings.getAt(2)->setValue(&value3);

    //�澯ԴID

    OIDImplTrapItem[11] = 2;
    OID oid4(OIDImplTrapItem, 12);
    pdu.variableBindings.getAt(3)->setOID(&oid4);
    Integer32 value4(type->itsAlarmSource());
    pdu.variableBindings.getAt(3)->setValue(&value4);

    //�澯����

    OIDImplTrapItem[11] = 3;
    OID oid5(OIDImplTrapItem, 12);
    pdu.variableBindings.getAt(4)->setOID(&oid5);
    Integer32 value5(type->itsAlarmLevel());
    pdu.variableBindings.getAt(4)->setValue(&value5);

    int pklen = pdu.getPDUBerLength();
    int buflen = pklen + 1 + SNMPPdu::getLengthBerLength(pklen);

    ///unsigned char *buf = new unsigned char[buflen];
    if (pdu.encode((unsigned char*) trapBuffer[endIndex].buffer, buflen,
            pklen)) {
        trapBuffer[endIndex].buffersize = buflen;
        trapBuffer[endIndex].valid = 1;
    } else {
        trapBuffer[endIndex].buffersize = 0;
        trapBuffer[endIndex].valid = 0;
    }

    pdu.variableBindings.variableBinding = NULL;
    endIndex++;
    if (endIndex >= TrapMaxNumber) {
        endIndex = 0;
    }

//sendUint32Value( Get_Time() - bt  );
}

/*void TrapList::insertNewPerformanceEventTrap(CPerformanceEventCurItem *pfitem)
 {
 //sendUint32Value(0xac000000);
 //uint32 bt = Get_Time();

 if(pfitem == NULL) return;
 if(endIndex != currentIndex)
 {
 //�Ƿ�buffer������� ����
 if((endIndex == TrapMaxNumber-1) && currentIndex == 0)
 {
 return;
 }
 else if((endIndex+1)== currentIndex )
 {
 return;
 }
 }
 OIDImplTrapItem[10] = 5;
 OIDImplEventID[10] = 4;
 SNMPPdu pdu;
 pdu.commond = SNMPPdu::TRAP;
 VariableBinding vb[7];
 pdu.variableBindings.variableBinding = vb;
 pdu.variableBindings.vbsLength = 7;
 //trap����ʱ��

 OID oid1(OIDImplTimeticks,9);
 pdu.variableBindings.getAt(0)->setOID(&oid1);
 TimeTicks value1(main->dateTime.currentTimeticks*100);
 //TimeTicks value1(pfitem->uiStarttime * 100);
 pdu.variableBindings.getAt(0)->setValue(&value1);

 //trap�¼�ID

 OID oid2(OIDTrapFix,11);
 pdu.variableBindings.getAt(1)->setOID(&oid2);
 OIDImplEventID[11] = pfitem->ucCountType;
 OID value2(OIDImplEventID,12);
 pdu.variableBindings.getAt(1)->setValue(&value2);

 //trap ��Ŀ����

 OIDImplTrapItem[11] = 1;
 OID oid3(OIDImplTrapItem,12);
 pdu.variableBindings.getAt(2)->setOID(&oid3);
 Integer32 value3(pfitem->uiIndex);
 pdu.variableBindings.getAt(2)->setValue(&value3);

 //ԴID

 OIDImplTrapItem[11] = 2;
 OID oid4(OIDImplTrapItem,12);
 pdu.variableBindings.getAt(3)->setOID(&oid4);
 Integer32 value4(pfitem->usSourceIndex);
 pdu.variableBindings.getAt(3)->setValue(&value4);

 //����

 OIDImplTrapItem[11] = 3;
 OID oid5(OIDImplTrapItem,12);
 pdu.variableBindings.getAt(4)->setOID(&oid5);
 Integer32 value5(pfitem->ucPeriod);
 pdu.variableBindings.getAt(4)->setValue(&value5);

 //����

 OIDImplTrapItem[11] = 4;
 OID oid6(OIDImplTrapItem,12);
 pdu.variableBindings.getAt(5)->setOID(&oid6);
 Integer32 value6(pfitem->ucTypeID);
 pdu.variableBindings.getAt(5)->setValue(&value6);

 //  trap��ʼʱ�䣬15���ӻ���24Сʱ��ʼʱ��

 OIDImplTrapItem[11] = 5;
 OID oid7(OIDImplTrapItem,12);
 pdu.variableBindings.getAt(6)->setOID(&oid7);
 TimeTicks value7(pfitem->uiStarttime * 100);
 pdu.variableBindings.getAt(6)->setValue(&value7);


 int pklen = pdu.getPDUBerLength();
 int buflen =  pklen+1+ SNMPPdu::getLengthBerLength(pklen);


 ///unsigned char *buf = new unsigned char[buflen];
 if( pdu.encode((unsigned char*)trapBuffer[endIndex].buffer,buflen,pklen) )
 {
 trapBuffer[endIndex].buffersize = buflen;
 trapBuffer[endIndex].valid = 1;
 }
 else
 {
 trapBuffer[endIndex].buffersize = 0;
 trapBuffer[endIndex].valid = 0;
 }



 pdu.variableBindings.variableBinding = NULL;
 endIndex++;
 if(endIndex>=TrapMaxNumber)
 {
 endIndex = 0;
 }

 //sendUint32Value( Get_Time() - bt  );
 }

 void TrapList::insertRecoveryPerformanceEventTrap(CPerformanceEventCurItem *pfitem)
 {
 //sendUint32Value(0xac000000);
 //uint32 bt = Get_Time();

 if(pfitem == NULL) return;
 if(endIndex != currentIndex)
 {
 //�Ƿ�buffer������� ����
 if((endIndex == TrapMaxNumber-1) && currentIndex == 0)
 {
 return;
 }
 else if((endIndex+1)== currentIndex )
 {
 return;
 }
 }
 OIDImplTrapItem[10] = 5;
 OIDImplEventID[10] = 4;
 SNMPPdu pdu;
 pdu.commond = SNMPPdu::TRAP;
 VariableBinding vb[7];
 pdu.variableBindings.variableBinding = vb;
 pdu.variableBindings.vbsLength = 7;
 //trap����ʱ��

 OID oid1(OIDImplTimeticks,9);
 pdu.variableBindings.getAt(0)->setOID(&oid1);
 TimeTicks value1(main->dateTime.currentTimeticks*100);
 pdu.variableBindings.getAt(0)->setValue(&value1);

 //trap�¼�ID

 OID oid2(OIDTrapFix,11);
 pdu.variableBindings.getAt(1)->setOID(&oid2);
 OIDImplEventID[11] = pfitem->ucCountType | 0x8000;
 OID value2(OIDImplEventID,12);
 pdu.variableBindings.getAt(1)->setValue(&value2);

 //trap ��Ŀ����

 OIDImplTrapItem[11] = 1;
 OID oid3(OIDImplTrapItem,12);
 pdu.variableBindings.getAt(2)->setOID(&oid3);
 Integer32 value3(pfitem->uiIndex);
 pdu.variableBindings.getAt(2)->setValue(&value3);

 //ԴID

 OIDImplTrapItem[11] = 2;
 OID oid4(OIDImplTrapItem,12);
 pdu.variableBindings.getAt(3)->setOID(&oid4);
 Integer32 value4(pfitem->usSourceIndex);
 pdu.variableBindings.getAt(3)->setValue(&value4);

 //����

 OIDImplTrapItem[11] = 3;
 OID oid5(OIDImplTrapItem,12);
 pdu.variableBindings.getAt(4)->setOID(&oid5);
 Integer32 value5(pfitem->ucPeriod);
 pdu.variableBindings.getAt(4)->setValue(&value5);

 //����

 OIDImplTrapItem[11] = 4;
 OID oid6(OIDImplTrapItem,12);
 pdu.variableBindings.getAt(5)->setOID(&oid6);
 Integer32 value6(pfitem->ucTypeID);
 pdu.variableBindings.getAt(5)->setValue(&value6);


 //����ʱ��
 OIDImplTrapItem[11] = 5;
 OID oid7(OIDImplTrapItem,12);
 pdu.variableBindings.getAt(6)->setOID(&oid7);
 TimeTicks value7(main->dateTime.currentTimeticks*100);
 pdu.variableBindings.getAt(6)->setValue(&value7);

 int pklen = pdu.getPDUBerLength();
 int buflen =  pklen+1+ SNMPPdu::getLengthBerLength(pklen);


 ///unsigned char *buf = new unsigned char[buflen];
 if( pdu.encode((unsigned char*)trapBuffer[endIndex].buffer,buflen,pklen) )
 {
 trapBuffer[endIndex].buffersize = buflen;
 trapBuffer[endIndex].valid = 1;
 }
 else
 {
 trapBuffer[endIndex].buffersize = 0;
 trapBuffer[endIndex].valid = 0;
 }



 pdu.variableBindings.variableBinding = NULL;
 endIndex++;
 if(endIndex>=TrapMaxNumber)
 {
 endIndex = 0;
 }

 //sendUint32Value( Get_Time() - bt  );
 }*/

bool TrapList::isHasTrapItem() {
    if (endIndex != currentIndex)
        return true;
    else
        return false;
}
void TrapList::sendaTrapItem() {

    if (endIndex == currentIndex)
        return;
    uint8* beSend = trapBuffer[currentIndex].buffer;
    uint16 sendLen = trapBuffer[currentIndex].buffersize;
    uint8* send_buff = udp_get_buf(sendLen);
#ifdef EZ_DEBUG
        printf("\nTrapList::sendaTrapItem error udp_get_buf\n");
#endif
    uint8 trapIP[4];
    DeviceComponent::getDeviceAttribute().getTrapDestIP(trapIP);
    if( send_buff == 0 ) {
        return;
    }
    memcpy( send_buff, beSend, sendLen );

//    while( arp_cache_ip(trapIP, ARP_FIXED_IP) != __TRUE ) {
//        if( !Protected ) {
//#ifdef EZ_DEBUG
//        strcpy(msg_ack, "Remote loss");
//#endif
//            return;
//        }
//        os_dly_wait(100);
//    };
    if( udp_send(soc_massage, trapIP, 162, send_buff, sendLen) != __TRUE ) {
#ifdef EZ_DEBUG
		printf("\nTrapList::sendaTrapItem error udp_send\n");
#endif
        return;
    }

    trapBuffer[currentIndex].valid = 0;
    currentIndex++;
    if (currentIndex >= TrapMaxNumber) {
        currentIndex = 0;
    }
}

TASK void tsk_trap(void)		//��������
{
    while( 1 ) {
        os_dly_wait(100);
        while( TrapList::instance().isHasTrapItem() ) {
            TrapList::instance().sendaTrapItem();
        }
    }
}

#endif

